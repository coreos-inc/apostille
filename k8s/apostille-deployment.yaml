kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: apostille
  namespace: apostille
  labels:
    app: apostille
spec:
  replicas: 1
  selector:
    matchLabels:
      app: apostille
  template:
    metadata:
      namespace: apostille
      labels:
        app: apostille
    spec:
      volumes:
        - name: apostille-server-config
          configMap:
            name: apostille-config
            items:
              - key: config.test.json
                path: config.json
            defaultMode: 420
        - name: apostille-signer-config
          configMap:
            name: apostille-signer-config
            items:
              - key: signer-config.json
                path: config.json
            defaultMode: 420
      containers:
        - resources: {}
          name: apostille-server
          command:
            - /bin/sh
            - '-c'
            - >-
              ./migrations/migrate.sh && apostille
              -config=/etc/config/config.json
          env:
            - name: DB_URL
              valueFrom:
                configMapKeyRef:
                  name: apostille-config
                  key: db.url
            - name: MIGRATIONS_PATH
              valueFrom:
                configMapKeyRef:
                  name: apostille-config
                  key: migrations.path
          ports:
            - name: web
              containerPort: 4443
              protocol: TCP
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: apostille-server-config
              mountPath: /etc/config
          image: 'quay.io/quay/apostille:v0.1'
        - resources: {}
          name: apostille-signer
          command:
            - /bin/sh
            - '-c'
            - >-
              /go/src/github.com/docker/notary/migrations/migrate.sh &&
              notary-signer -config=/etc/config/config.json
          env:
            - name: NOTARY_SIGNER_TIMESTAMP_1
              valueFrom:
                configMapKeyRef:
                  name: apostille-signer-config
                  key: notary.signer.timestamp.1.password
            - name: GOPATH
              value: /go/src
            - name: DB_URL
              valueFrom:
                configMapKeyRef:
                  name: apostille-signer-config
                  key: db.url
            - name: MIGRATIONS_PATH
              valueFrom:
                configMapKeyRef:
                  name: apostille-signer-config
                  key: migrations.path
          ports:
            - name: grpc
              containerPort: 7899
              protocol: TCP
          imagePullPolicy: Always
          volumeMounts:
            - name: apostille-signer-config
              mountPath: /etc/config
          image: 'quay.io/quay/apostille-signer:v0.1.1'
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      dnsPolicy: ClusterFirst
      securityContext: {}
      imagePullSecrets:
        - name: quay-apostille-pull-secret
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 4
  minReadySeconds: 60
